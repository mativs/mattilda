# Project Rules

## General
- Keep changes small, explicit, and production-oriented.
- Follow current project structure (hexagonal-inspired backend folders).
- Do not remove or break existing working behavior unless explicitly requested.
- Prefer incremental edits over broad refactors.
- Update docs/config when behavior, commands, or defaults change.

## Backend
- Python with FastAPI, SQLAlchemy, Alembic, and uv dependency workflow.
- Prefer clear service-layer logic and explicit dependency injection patterns.
- Keep public endpoints explicit; auth/role/ownership checks must be enforced in backend.
- Keep API schemas explicit and response-model-safe (no leaking internal fields like hashed passwords).
- Keep role checks and ownership checks separated and test both.
- Preserve one public non-auth endpoint (`/api/v1/ping`) for smoke checks.
- Keep hexagonal exception boundaries:
  - Application/services must use framework-agnostic exceptions only.
  - FastAPI `HTTPException` and HTTP status mapping belong to interface adapters/handlers.
- For entities with associations (users/students), keep association diff/sync in backend services.
  - `PUT` update contracts should accept partial `associations.add/remove` operations.
  - Frontend should send desired deltas; backend computes and applies valid changes.
- Standardize list endpoints (`/users`, `/schools`, `/students`, `/fees`, `/charges`, `/students/{student_id}/invoices`, `/students/{student_id}/payments`) with shared pagination/search contracts:
  - Query params: `offset`, `limit`, `search`.
  - Response envelope: `{ items, pagination }`.
  - Use shared pagination/search helpers instead of duplicating ad-hoc query/count logic.

## Security
- Never log, return, or expose passwords, hashed passwords, or JWT secrets.
- New protected endpoints must use authentication dependency and role/ownership policy.
- Prefer deterministic error responses for unauthorized/forbidden flows (`401` vs `403`).

## Database and Migrations
- Use Alembic for schema changes; do not rely on runtime `create_all`.
- Every model change that affects schema requires a migration update.
- Migration scripts should be idempotent-safe when possible (`checkfirst`, `IF EXISTS`/`IF NOT EXISTS` where appropriate).
- Keep seed scripts rerunnable (no duplicate record creation).

## Frontend
- React app should consume backend API using `VITE_API_URL`.
- Keep auth/session flow simple and readable.
- Keep login/session UX minimal and functional; frontend role logic is UX-only, not authorization.
- For list endpoints that return paginated envelopes, consume `payload.items` (not raw array payloads).

## Testing
- Use pytest.
- Organize tests by scope:
  - `backend/tests/services`: one test file per service module with small DB-backed behavior tests.
  - `backend/tests/endpoints`: one test file per route module with focused request/response and auth contract checks.
  - `backend/tests/end2end`: cross-endpoint journey tests only.
- Keep tests small and single-action by default:
  - Endpoint tests: exactly one HTTP request call per test method.
  - Service tests: exactly one primary service method call per test method.
  - Multi-step orchestration belongs only in `backend/tests/end2end`.
- Prefer test helpers/factories for setup state (no raw SQL in test method bodies).
- Every test method must start with a docstring in this exact style:
  """
  Short description of the test.

  1. Step one...
  2. Step two...
  3. Validate expected behavior...
  4. Validate additional expectation...
  """
- Keep assertions explicit and behavior-focused.
- Cover positive and negative auth flows (invalid credentials, invalid token, forbidden role, ownership violation).
- If coverage gates are configured, keep them passing.

## Validation Checklist For Changes
- Backend tests pass: `docker compose run --rm backend uv run pytest`
- Migrations apply cleanly: `docker compose run --rm backend uv run alembic upgrade head`
- Seed script runs: `docker compose run --rm backend uv run python -m scripts.seed_data`
- Stack is healthy: `docker compose up --build -d` and verify backend/frontend endpoints.
